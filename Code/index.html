<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JEERA - Task Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #header {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #taskForm {
      margin-bottom: 20px;
    }
    #tasks-container {
      display: flex;
      width: 100%;
      justify-content: space-around;
    }
    .column {
      width: 30%;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 300px;
      background: #f9f9f9;
    }
    .task-card {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      cursor: move;
    }
    .task-card.completed {
      background: #e0e0e0;
      color: #888;
    }
  </style>
</head>
<body>
  <div id="header">
    JEERA - Your Task Management Solution
  </div>

  <!-- Task creation form -->
  <form id="taskForm">
    <h2>Create Task</h2>
    <label for="title">Title:</label>
    <input type="text" id="title" name="title" required>
    <label for="description">Description:</label>
    <textarea id="description" name="description" required></textarea>
    <label for="due_date">Due Date:</label>
    <input type="date" id="due_date" name="due_date" required>
    <button type="submit">Create Task</button>
  </form>

  <!-- Task Display and Columns -->
  <div id="tasks-container">
    <div id="todo-column" class="column" ondrop="drop(event)" ondragover="allowDrop(event)">
      <h3>To Do</h3>
    </div>
    <div id="in-progress-column" class="column" ondrop="drop(event)" ondragover="allowDrop(event)">
      <h3>In Progress</h3>
    </div>
    <div id="done-column" class="column" ondrop="drop(event)" ondragover="allowDrop(event)">
      <h3>Done</h3>
    </div>
  </div>

  <!-- JavaScript for dynamic content updates and AJAX -->
  <script>
    function ajaxRequest(url, method, formData, callback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, url, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function() {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response:', response); // Log response for debugging
            callback(response);
          } catch (e) {
            console.error('Error parsing JSON:', e);
          }
        } else {
          console.error('Error with request:', xhr.statusText);
        }
      };
      xhr.onerror = function() {
        console.error('Network error:', xhr.statusText);
      };
      xhr.send(formData);
    }

    document.getElementById('taskForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const formData = `title=${encodeURIComponent(document.getElementById('title').value)}&description=${encodeURIComponent(document.getElementById('description').value)}&due_date=${encodeURIComponent(document.getElementById('due_date').value)}`;
      ajaxRequest('index.php?action=create_task', 'POST', formData, function(response) {
        if (response.message === 'Task created successfully') {
          loadTasks();
        } else {
          alert('Failed to create task.');
        }
      });
    });

    function loadTasks() {
      ajaxRequest('index.php?action=get_tasks', 'GET', null, function(response) {
        const todoColumn = document.getElementById('todo-column');
        const inProgressColumn = document.getElementById('in-progress-column');
        const doneColumn = document.getElementById('done-column');

        todoColumn.innerHTML = '<h3>To Do</h3>';
        inProgressColumn.innerHTML = '<h3>In Progress</h3>';
        doneColumn.innerHTML = '<h3>Done</h3>';

        if (!response.tasks || response.tasks.length === 0) {
          todoColumn.innerHTML += '<p>No tasks to display</p>';
          inProgressColumn.innerHTML += '<p>No tasks to display</p>';
          doneColumn.innerHTML += '<p>No tasks to display</p>';
        } else {
          response.tasks.forEach(task => {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.draggable = true;
            taskCard.ondragstart = drag;
            taskCard.id = `task-${task.id}`;
            taskCard.dataset.id = task.id;
            taskCard.innerHTML = `
              <h3>${task.title}</h3>
              <p>${task.description}</p>
              <p>Due: ${task.due_date}</p>
              <button onclick="updateTask(${task.id})">Update</button>
            `;

            // Apply styles and draggable attribute based on status
            if (task.status === 'Done') {
              taskCard.classList.add('completed');
              taskCard.draggable = false;
            } else {
              taskCard.draggable = true;
            }

            if (task.status === 'To Do') {
              todoColumn.appendChild(taskCard);
            } else if (task.status === 'In Progress') {
              inProgressColumn.appendChild(taskCard);
            } else if (task.status === 'Done') {
              doneColumn.appendChild(taskCard);
            }
          });
        }
      });
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }
    function drag(ev) {
      const taskId = ev.target.id;
      console.log('Dragging task:', taskId); // Debug log
      ev.dataTransfer.setData("text/plain", taskId);
    }

    function drop(ev) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text/plain");
      const taskCard = document.getElementById(data);

      if (!taskCard) {
        console.error('No task card found for data:', data);
        return;
      }

      const taskId = taskCard.dataset.id;
      if (!taskId) {
        console.error('Task card has no dataset id:', taskCard);
        return;
      }

      const column = ev.target.closest('.column');
      if (!column) {
        console.error('No column found for target:', ev.target);
        return;
      }

      // Adjust status ID mapping
      const newStatus = column.id;
      let statusId;
      switch (newStatus) {
        case 'todo-column':
          statusId = 1;
          break;
        case 'in-progress-column':
          statusId = 2;
          break;
        case 'done-column':
          statusId = 3;
          break;
        default:
          console.error('Invalid new status:', newStatus);
          return; // Exit function to prevent sending invalid status
      }

      // Update task card style based on the new status
      if (newStatus === 'done-column') {
        taskCard.classList.add('completed');
        taskCard.draggable = false;
      } else {
        taskCard.classList.remove('completed');
        taskCard.draggable = true;
      }

      const title = taskCard.querySelector('h3').innerText;
      const description = taskCard.querySelector('p').innerText.split('Due: ')[0];

      ajaxRequest('index.php?action=update_task', 'POST', `id=${taskId}&status_id=${statusId}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}`, function(response) {
        if (response.message === 'Task updated successfully') {
          loadTasks();
        } else {
          alert('Failed to update task.');
        }
      });

      column.appendChild(taskCard);
    }


    function updateTask(taskId) {
      const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
      const newTitle = prompt('Enter new title:', taskCard.querySelector('h3').innerText);
      const newDescription = prompt('Enter new description:', taskCard.querySelector('p').innerText.split('Due: ')[0]);
      const status = taskCard.parentElement.id.replace('-column', '').replace('-', ' ');
      let statusId;

      switch (status) {
        case 'to do':
          statusId = 1;
          break;
        case 'in progress':
          statusId = 2;
          break;
        case 'done':
          statusId = 3;
          break;
        default:
          statusId = null;
      }

      const formData = `id=${taskId}&title=${encodeURIComponent(newTitle)}&description=${encodeURIComponent(newDescription)}&status_id=${encodeURIComponent(statusId)}`;
      ajaxRequest('index.php?action=update_task', 'POST', formData, function(response) {
        if (response.message === 'Task updated successfully') {
          loadTasks();
        } else {
          alert('Failed to update task.');
        }
      });
    }

    loadTasks();

  </script>
</body>
</html>
